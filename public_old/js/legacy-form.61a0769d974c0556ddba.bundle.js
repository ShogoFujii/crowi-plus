webpackJsonp([5],{1171:function(e,t,n){"use strict";(function(e){function t(t){e.get("/_api/pages.updatePost",{path:t},(function(t){if(t.ok){e("#page-form-slack-channel").val(t.updatePost.join(","))}}))}function r(){var e=document.querySelector("#form-body"),t=e.getAttribute("data-caret-position");null!==t&&(e.blur(),e.focus(),e.scrollTop=e.scrollHeight,e.selectionStart=t,e.selectionEnd=t,e.removeAttribute("data-caret-position"))}var a=e("#content-main").data("page-id"),o=e("#content-main").data("path"),s=e("#content-main").data("linebreaks-enabled"),i={marked:{breaks:s}};n(427),n(1172),n(1173);var c=n(1174),l=e("#page-form-setting").data("slack-configured");a||(!a&&o.match(/(20\d{4}|20\d{6}|20\d{2}_\d{1,2}|20\d{2}_\d{1,2}_\d{1,2})/)&&e("#page-warning-modal").modal("show"),l&&t(o)),e('a[data-toggle="tab"][href="#edit-form"]').on("show.bs.tab",(function(){if(e(".content-main").addClass("on-edit"),l){""===e("#page-form-slack-channel").val()&&t(o)}})),e('a[data-toggle="tab"][href="#edit-form"]').on("hide.bs.tab",(function(){e(".content-main").removeClass("on-edit")}));new MutationObserver(function(e){e[0].target.classList.contains("active")&&r()}).observe(document.querySelector("#edit-form"),{attributes:!0,attributeFilter:["class"]}),e((function(){function t(){var t=e("#form-body").val(),n=e("#preview-body"),r={markdown:t,dom:n,currentPagePath:decodeURIComponent(location.pathname)};crowi.interceptorManager.process("preRenderPreview",r).then((function(){return crowi.interceptorManager.process("prePreProcess",r)})).then((function(){r.markdown=crowiRenderer.preProcess(r.markdown,r.dom)})).then((function(){return crowi.interceptorManager.process("postPreProcess",r)})).then((function(){var e=crowiRenderer.render(r.markdown,r.dom,i);r.parsedHTML=e})).then((function(){return crowi.interceptorManager.process("postRenderPreview",r)})).then((function(){return crowi.interceptorManager.process("preRenderPreviewHtml",r)})).then((function(){e("#preview-body").html(r.parsedHTML),Promise.resolve(e("#preview-body"))})).then((function(e){return r=Object.assign(r,{bodyElement:e}),crowi.interceptorManager.process("postRenderPreviewHtml",r)}))}var n=e("#form-body").val(),r=crowi.findDraft(o);!e('#page-form [name="pageForm[currentRevision]"]').val()&&r&&e("#form-body").val(r);var a=n;t();var s=(setInterval((function(){var n=e("#form-body").val();a!=n&&(t(),a=n)}),500),!1);e(window).on("beforeunload",(function(e){if(s)return"You haven't finished your comment yet. Do you want to leave without finishing?"})),e("#form-body").on("keyup change",(function(t){var r=e("#form-body").val();n!=r?(s=!0,crowi.saveDraft(o,r)):(s=!1,crowi.clearDraft(o))})),e("#page-form").on("submit",(function(e){s=!1,crowi.clearDraft(o)}));var l=function(e,t,n,r){var a=document.querySelector("#form-body");switch(r=r||"after"){case"before":a.setSelectionRange(e,e);break;case"replace":a.setSelectionRange(e,t);break;case"after":default:a.setSelectionRange(t,t)}a.focus();var o=!1;try{o=document.execCommand("insertText",!1,n)}catch(e){o=!1}o||(a.value=a.value.substr(0,e)+n+a.value.substr(t))},d=function(t){var n=e(t.target),r=n.val(),a=n.selection("getPos");if(null===r||a.start!==a.end)return null;var o=r.lastIndexOf("\n",a.start-1)+1,s=r.indexOf("\n",a.start);return-1===s&&(s=r.length),{text:r.slice(o,s),start:o,end:s,caret:a.start,endOfLine:!e.trim(r.slice(a.start,s))}},u=function(t){var n=e(t.target),r=d(t),a=n.val().slice(0,r.start),o=a.lastIndexOf("\n",r.start-2)+1,s=r.start;return{text:a.slice(o,s),start:o,end:s}},f=function(t){t.preventDefault();var n=e(t.target),r=d(t),a=n.val(),o=n.selection("getPos");if(!0!==t.ctrlKey){if(r&&n.selection("setPos",{start:r.start,end:r.end-1}),!0===t.shiftKey)if(r&&"|"===r.text.charAt(0)){var s=a.lastIndexOf("|",o.start-1);s>0&&n.selection("setPos",{start:s-1,end:s-1})}else{var i=n.selection().replace(/^ {1,4}/gm,""),c=n.selection().length-i.length;n.selection("replace",{text:i,mode:"before"}),r&&n.selection("setPos",{start:o.start-c,end:o.start-c})}else if(r&&"|"===r.text.charAt(0)){var s=a.indexOf("|",o.start+1);s<0||s===a.lastIndexOf("|",r.end-1)?n.selection("setPos",{start:r.end,end:r.end}):n.selection("setPos",{start:s+2,end:s+2})}else n.selection("replace",{text:"    "+n.selection().split("\n").join("\n    "),mode:"before"}),r&&n.selection("setPos",{start:o.start+4,end:o.start+4});n.trigger("input")}},v=function(t){if(!(t.metaKey||t.ctrlKey||t.shiftKey)){var n=d(t);if(n&&n.start!==n.caret){var r=e(t.target),a=n.text.match(/^(\s*(?:-|\+|\*|\d+\.) (?:\[(?:x| )\] )?)\s*\S/);if(a){if(n.text.match(/^(\s*(?:-|\+|\*|\d+\.) (?:\[(?:x| )\] ))\s*$/))return void r.selection("setPos",{start:n.start,end:n.end-1});t.preventDefault();var o=a[1].replace(/\[x\]/,"[ ]"),s=o.match(/^(\s*)(\d+)\./);if(s){var i=s[1],c=parseInt(s[2]);1!==c&&(o=o.replace(/\s*\d+/,i+(c+1)))}var f=r.selection("getPos");l(f.start,f.start,"\n"+o,"replace");var v=f.start+("\n"+o).length;r.selection("setPos",{start:v,end:v})}else if(n.text.match(/^(\s*(?:-|\+|\*|\d+\.) )/))r.selection("setPos",{start:n.start,end:n.end});else if(n.text.match(/^.*\|\s*$/)){if(n.text.match(/^[\|\s]+$/))return void r.selection("setPos",{start:n.start,end:n.end});if(!n.endOfLine)return;t.preventDefault();for(var g=[],p=n.text.match(/\|/g),h=0;h<p.length;h++)g.push("|");var m=u(t);if(m&&(n.text.match(/---/)||m.text.match(/\|/g))){var f=r.selection("getPos");l(f.start,f.end,"\n"+g.join("  "),"after"),r.selection("setPos",{start:n.caret+3,end:n.caret+3})}else{var f=r.selection("getPos");l(f.start,f.start,"\n"+g.join(" --- ")+"\n"+g.join("  "),"after"),r.selection("setPos",{start:n.caret+6*g.length-1,end:n.caret+6*g.length-1})}}r.trigger("input")}}},g=function(t){t.preventDefault(),e(t.target).blur()},p=function(t){if(t.shiftKey&&t.altKey){var n=d(t);if(n){var r=e(t.target),a=n.text.match(/^(\s*)(-|\+|\*|\d+\.) (?:\[(x| )\] )(.*)/);if(a){t.preventDefault();var o=" "==a[3]?"x":" ",s=a[1]+a[2]+" ["+o+"] "+a[4];r.selection("setPos",{start:n.start,end:n.end}),l(n.start,n.end,s,"replace"),r.selection("setPos",{start:n.caret,end:n.caret}),r.trigger("input")}}}},h=function(t){if(t.ctrlKey||t.metaKey){t.preventDefault();var n=e('#page-form [name="pageForm[currentRevision]"]'),r=e("#form-body").val(),a=void 0,s=void 0;T?(a="/pages.update",s={page_id:T,revision_id:n.val(),body:r}):(a="/pages.create",s={path:o,body:r}),crowi.apiPost(a,s).then((function(e){var t=e.page;T=t._id,c.success(void 0,"Saved successful",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"1200",extendedTimeOut:"150"}),n.val(t.revision._id)})).catch((function(e){console.error(e),c.error(e.message,"Error occured on saveing",{closeButton:!0,progressBar:!0,newestOnTop:!1,showDuration:"100",hideDuration:"100",timeOut:"3000"})}))}};e("textarea#form-body").on("keydown",(function(e){switch(e.which||e.keyCode){case 9:f(e);break;case 13:v(e);break;case 27:g(e);break;case 32:p(e);break;case 83:h(e)}}));var m=function(t){var n=d(t);if(!n)return!1;var r=e(t.target),a=t.clipboardData.getData("text"),o=n.text.match(/^(\s*(?:>|\-|\+|\*|\d+\.) (?:\[(?:x| )\] )?)/);o&&a.match(/(?:\r\n|\r|\n)/)&&(a=a.replace(/(\r\n|\r|\n)/g,"$1"+o[1])),l(n.caret,n.caret,a,"replace");var s=n.caret+a.length;return r.selection("setPos",{start:s,end:s}),!0};document.getElementById("form-body").addEventListener("paste",(function(e){m(e)&&e.preventDefault()}));var b=function(e){e.unbind(".inlineattach")},x=function(e,t){var n=w(e),r=new inlineAttachment(t,n);e.bind({"paste.inlineattach":function(e){r.onPaste(e.originalEvent)},"drop.inlineattach":function(e){e.stopPropagation(),e.preventDefault(),r.onDrop(e.originalEvent)},"dragenter.inlineattach dragover.inlineattach":function(e){e.stopPropagation(),e.preventDefault()}})},w=function(e){var t=e;return{getValue:function(){return t.val()},insertValue:function(e){inlineAttachment.util.insertTextAtCursor(t[0],e)},setValue:function(e){t.val(e)}}},y=e("form.uploadable textarea#form-body");if(y.length>0){var P=e("form.uploadable input#edit-form-csrf").val(),T=e("#content-main").data("page-id")||0,R={uploadUrl:"/_api/attachments.add",extraParams:{path:location.pathname,page_id:T,_csrf:P},progressText:"(Uploading file...)",jsonFieldName:"url"};crowi.getConfig().upload.file&&(R.allowedTypes="*"),R.remoteFilename=function(e){return e.name},R.onFileReceived=function(e){e.type.match(/^image\/.+$/)?this.settings.urlText="!["+e.name+"]({filename})\n":(this.settings.urlText='<a href="{filename}">'+e.name+"</a>\n",this.settings.urlText="["+e.name+"]({filename})\n")},R.onFileUploadResponse=function(t){var n=JSON.parse(t.response);if(n.ok&&n.pageCreated){var r=n.page,a=r._id;e("#content-main").data("page-id",r._id),e('#page-form [name="pageForm[currentRevision]"]').val(r.revision._id),b(y),R.extraParams.page_id=a,x(y,R)}return!0},x(y,R),e("textarea#form-body").on("dragenter dragover",(function(){e(this).addClass("dragover")})),e("textarea#form-body").on("drop dragleave dragend",(function(){e(this).removeClass("dragover")}))}(function(){var e=function(e){var t=e.getBoundingClientRect();return e.scrollHeight-t.height},t=function(t){var n=e(t);return t.scrollTop/n},n=function(t,n){return e(t)*n},r=document.querySelector("#form-body"),a=document.querySelector("#preview-body");r.addEventListener("scroll",(function(e){var r=t(this),o=n(a,r);a.scrollTop=o}))})()}))}).call(t,n(18))},1173:function(e,t,n){"use strict";(function(e){(function(e,t,n){var r=function(e){var r={text:"",start:0,end:0};if(!e.value)return r;try{if(t.getSelection)r.start=e.selectionStart,r.end=e.selectionEnd,r.text=e.value.slice(r.start,r.end);else if(n.selection){e.focus();var a=n.selection.createRange(),o=n.body.createTextRange();r.text=a.text;try{o.moveToElementText(e),o.setEndPoint("StartToStart",a)}catch(t){o=e.createTextRange(),o.setEndPoint("StartToStart",a)}r.start=e.value.length-o.text.length,r.end=r.start+a.text.length}}catch(e){}return r},a={getPos:function(e){var t=r(e);return{start:t.start,end:t.end}},setPos:function(e,n,r){r=this._caretMode(r),"start"===r?n.end=n.start:"end"===r&&(n.start=n.end),e.focus();try{if(e.createTextRange){var a=e.createTextRange();t.navigator.userAgent.toLowerCase().indexOf("msie")>=0&&(n.start=e.value.substr(0,n.start).replace(/\r/g,"").length,n.end=e.value.substr(0,n.end).replace(/\r/g,"").length),a.collapse(!0),a.moveStart("character",n.start),a.moveEnd("character",n.end-n.start),a.select()}else e.setSelectionRange&&e.setSelectionRange(n.start,n.end)}catch(e){}},getText:function(e){return r(e).text},_caretMode:function(e){switch(e=e||"keep",!1===e&&(e="end"),e){case"keep":case"start":case"end":break;default:e="keep"}return e},replace:function(t,n,a){var o=r(t),s=t.value,i=e(t).scrollTop(),c={start:o.start,end:o.start+n.length};t.value=s.substr(0,o.start)+n+s.substr(o.end),e(t).scrollTop(i),this.setPos(t,c,a)},insertBefore:function(t,n,a){var o=r(t),s=t.value,i=e(t).scrollTop(),c={start:o.start+n.length,end:o.end+n.length};t.value=s.substr(0,o.start)+n+s.substr(o.start),e(t).scrollTop(i),this.setPos(t,c,a)},insertAfter:function(t,n,a){var o=r(t),s=t.value,i=e(t).scrollTop(),c={start:o.start,end:o.end};t.value=s.substr(0,o.end)+n+s.substr(o.end),e(t).scrollTop(i),this.setPos(t,c,a)}};e.extend({selection:function(r){var a="text"===(r||"text").toLowerCase();try{if(t.getSelection){if(a)return t.getSelection().toString();var o,s=t.getSelection();return s.getRangeAt?o=s.getRangeAt(0):(o=n.createRange(),o.setStart(s.anchorNode,s.anchorOffset),o.setEnd(s.focusNode,s.focusOffset)),e("<div></div>").append(o.cloneContents()).html()}if(n.selection)return a?n.selection.createRange().text:n.selection.createRange().htmlText}catch(e){}return""}}),e.fn.extend({selection:function(e,t){switch(t=t||{},e){case"getPos":return a.getPos(this[0]);case"setPos":return this.each((function(){a.setPos(this,t)}));case"replace":return this.each((function(){a.replace(this,t.text,t.caret)}));case"insert":return this.each((function(){"before"===t.mode?a.insertBefore(this,t.text,t.caret):a.insertAfter(this,t.text,t.caret)}));case"get":default:return a.getText(this[0])}return this}})})(e,window,window.document)}).call(t,n(18))},18:function(e,t){e.exports=jQuery}},[1171]);